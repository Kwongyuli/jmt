<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <title>Meal Detail</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: beige;
        }

        .container {
            font-family: "Dongle", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 2vw;
            height: 100vh;
            margin-top: 17vh;
            margin-left: 15vw;
            margin-right: 15vw;
        }

        .main {
            width: 100%;
            padding-top: 2vw;
        }

        div#head {
            text-align: center;
            border: 0.15vw solid black;
            border-radius: 1vw;
            background-color: white;
            height: 4vw;
            margin-bottom: 2vw;
            padding-left: 1.5vw;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.7vw;
        }

        div#con {
            border: 0.15vw solid black;
            border-radius: 1vw;
            background-color: white;
            padding: 1vw;
        }

        #map {
            width: 85%;
            height: 350px;
        }
    </style>
</head>


<body>
    <div th:replace="common/header"></div>

    <div class="container">
        <div class="main">
            <div id="head">
                <div>ì‹ì‚¬ ìƒì„¸ í˜ì´ì§€</div>
            </div>
            <div id="con">

                <div>
                    <h2 th:text="${meal.title}">ì œëª©</h2>
                    <p>ì‘ì„±ì¼: <span th:text="${meal.createdAt}"></span></p>

                    <p th:text="${meal.content}">ë‚´ìš©</p>

                    <div id="map"></div>

                    <div>
                        <!-- ì´ë¯¸ì§€ ë³´ì´ê²Œ í•˜ê¸° eachë¡œ ë°˜ë³µë¬¸, íƒ€ì„ë¦¬í”„ì—ì„œëŠ” th ë‹¤ìŒìœ¼ë¡œ ë³´ê¸° -->
                        <div th:each="fileInfo : ${meal.fileInfos}">
                            <img th:src="@{|/download?fileId=${fileInfo.id}|}"
                                style="max-width: 100px; max-height: 100px;">
                        </div>
                    </div>
                </div>

                <!--ì¶”ì²œ ë¹„ì¶”ì²œ-->
                <div>
                    <button type="button" id="upvotes" th:text="@{|ì¶”ì²œğŸ‘ ${upvotes}|}" onclick="upvote()">ì¶”ì²œ</button>
                    <button type="button" id="downvotes" th:text="@{|ë¹„ì¶”ì²œğŸ‘ ${downvotes}|}"
                        onclick="downvote()">ë¹„ì¶”ì²œ</button>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <h2>ëŒ“ê¸€</h2>
                <ul>
                    <li th:each="comment : ${comments}">
                        <p th:text="${comment.comment}"></p>
                        <form
                            th:action="@{/meals/{mealId}/comment/{commentId}/delete(mealId=${meal.id}, commentId=${comment.id})}"
                            method="post">
                            <button type="submit">ì‚­ì œ</button>
                        </form>
                    </li>
                </ul>

                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <form th:action="@{/meals/{id}/comment(id=${meal.id})}" method="post">
                    <textarea name="comment" rows="4" cols="50"></textarea>
                    <button type="submit">ëŒ“ê¸€ ì¶”ê°€</button>
                </form>

                <a th:href="@{/meals/{id}/edit(id=${meal.id})}">ìˆ˜ì •</a>
                <form th:action="@{/meals/{id}/delete(id=${meal.id})}" method="post">
                    <button type="submit">ì‚­ì œ</button>
                </form>
                <a th:href="@{/meals/list}">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

            </div>
        </div>
    </div>

    <div class="footer"></div>

    <script src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=da146a2a6ff6a54903c1d2a7caecd1c7"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            // Thymeleafë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ latì™€ lng ê°’ì„ ì„¤ì •
            const lat = /*[[${meal.lat}]]*/ 33.450701;
            const lng = /*[[${meal.lng}]]*/ 126.570667;
            var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
                mapOption = {
                    center: new kakao.maps.LatLng(lat, lng), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                    level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                };
            var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤
            var markerPosition = new kakao.maps.LatLng(lat, lng);
            // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            var marker = new kakao.maps.Marker({
                position: markerPosition
            });
            // ë§ˆì»¤ê°€ ì§€ë„ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
            marker.setMap(map);
        });

        function sendVote(url) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('upvotes').innerText = "ì¶”ì²œğŸ‘ " + response.upvotes;
                    document.getElementById('downvotes').innerText = "ë¹„ì¶”ì²œğŸ‘ " + response.downvotes;
                    alert(response.message);
                }
            };
            xhr.send();
        }

        function upvote() {
            var mealId = /*[[${meal.id}]]*/ 0;
            var url = '/meals/' + mealId + '/upvote';
            sendVote(url);
        }

        function downvote() {
            var mealId = /*[[${meal.id}]]*/ 0;
            var url = '/meals/' + mealId + '/downvote';
            sendVote(url);
        }


        // ëŒ“ê¸€ ì‚­ì œ
        function deleteComment(commentId) {
            var loggedInUser = [[${loggedInUser}]];
            if (!loggedInUser) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                window.location.href = '/login';
                return;
            }

            var mealId = /*[[${meal.id}]]*/ 0;
            var url = '/meals/' + mealId + '/comment/' + commentId + '/delete';
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    window.location.reload();
                }
            };
            xhr.send();
        }

        /*]]>*/
    </script>

</body>

</html>
